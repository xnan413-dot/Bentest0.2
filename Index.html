<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€è²¨æ¨¡æ“¬å™¨ ğŸšš</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes delivery-move {
            0% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }
        .delivery-animate {
            animation: delivery-move 1s ease-in-out infinite;
        }
        .building {
            transition: all 0.3s ease;
        }
        .building:hover {
            transform: scale(1.05);
        }
        .order-card {
            transition: all 0.3s ease;
        }
        .order-card:hover {
            transform: translateX(5px);
        }
        @keyframes levelUp {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .level-up-animation {
            animation: levelUp 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 transition-colors">
    <div class="min-h-screen p-4 md:p-6">
        <!-- Header -->
        <div class="max-w-7xl mx-auto mb-6">
            <div class="bg-gradient-to-r from-primary to-purple-600 rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between flex-wrap gap-3">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold text-white mb-2 flex items-center gap-3">
                            ğŸšš é€è²¨æ¨¡æ“¬å™¨
                        </h1>
                        <p class="text-white/90 text-base" id="game-mode-text">æˆç‚ºæœ€ä½³é€è²¨å“¡ï¼æº–æ™‚é€é”ï¼Œè³ºå–æ”¶å…¥ï¼</p>
                    </div>
                    <div class="flex gap-3">
                        <div id="stage-info" class="hidden bg-white/20 backdrop-blur-sm rounded-lg px-4 py-3 text-white">
                            <div class="text-sm opacity-90">ç•¶å‰é—œå¡</div>
                            <div class="text-2xl font-bold" id="current-stage-name">é—œå¡ 1</div>
                            <div class="text-xs opacity-75 mt-1">
                                ğŸ“¦ <span id="stage-progress-text">0/5</span> | â±ï¸ <span id="stage-time-left">3:00</span>
                            </div>
                        </div>
                        <div id="level-info" class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-3 text-white">
                            <div class="text-sm opacity-90">ç­‰ç´š</div>
                            <div class="text-3xl font-bold" id="level">1</div>
                            <div class="text-xs opacity-75 mt-1">
                                <span id="level-progress">0</span>/<span id="level-target">10</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Panel -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">ğŸ’° æ”¶å…¥</div>
                    <div class="text-2xl font-bold text-green-600" id="money">HK$0</div>
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">ğŸ“¦ å·²å®Œæˆ</div>
                    <div class="text-2xl font-bold text-primary" id="completed">0</div>
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">â­ è©•åˆ†</div>
                    <div class="text-2xl font-bold text-yellow-500" id="rating">5.0</div>
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">â±ï¸ æ™‚é–“</div>
                    <div class="text-2xl font-bold text-blue-600" id="time">0:00</div>
                </div>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Map Area -->
            <div class="lg:col-span-2">
                <div class="bg-gray-100 dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
                        ğŸ—ºï¸ é…é€å€åŸŸ
                        <span class="text-sm font-normal text-gray-600 dark:text-gray-400" id="position">ä½ç½®: å€‰åº«</span>
                    </h2>
                    <div id="map" class="relative bg-green-100 dark:bg-green-900/20 rounded-lg overflow-hidden" style="height: 500px; max-height: 70vh;">
                        <!-- Roads -->
                        <div class="absolute inset-0">
                            <!-- Horizontal roads -->
                            <div class="absolute w-full h-2 bg-gray-400 dark:bg-gray-600" style="top: 25%;"></div>
                            <div class="absolute w-full h-2 bg-gray-400 dark:bg-gray-600" style="top: 50%;"></div>
                            <div class="absolute w-full h-2 bg-gray-400 dark:bg-gray-600" style="top: 75%;"></div>
                            <!-- Vertical roads -->
                            <div class="absolute h-full w-2 bg-gray-400 dark:bg-gray-600" style="left: 25%;"></div>
                            <div class="absolute h-full w-2 bg-gray-400 dark:bg-gray-600" style="left: 50%;"></div>
                            <div class="absolute h-full w-2 bg-gray-400 dark:bg-gray-600" style="left: 75%;"></div>
                        </div>

                        <!-- Buildings will be added dynamically -->
                        <div id="buildings"></div>

                        <!-- Delivery Van -->
                        <div id="van" class="absolute transition-all duration-500 ease-in-out" style="left: 10%; top: 10%; z-index: 100;">
                            <div class="text-4xl delivery-animate">ğŸšš</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Panel -->
            <div class="lg:col-span-1">
                <div class="bg-gray-100 dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-6">
                    <h2 class="text-xl font-bold mb-4">ğŸ“‹ å¾…æ¥è¨‚å–®</h2>

                    <div id="orders" class="space-y-3 mb-4 max-h-64 overflow-y-auto">
                        <!-- Orders will be added dynamically -->
                    </div>

                    <div class="space-y-3 border-t border-gray-300 dark:border-gray-700 pt-4">
                        <h3 class="font-bold text-lg">ğŸš€ ç•¶å‰é…é€</h3>
                        <div id="current-delivery" class="text-sm text-gray-600 dark:text-gray-400">
                            æš«ç„¡é…é€ä»»å‹™
                        </div>
                    </div>

                    <div class="mt-6 space-y-2">
                        <button id="stage-select-btn" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-3 px-4 rounded-lg transition text-base">
                            ğŸ¯ é—œå¡é¸æ“‡
                        </button>
                        <button id="start-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition text-base">
                            ğŸ® è‡ªç”±æ¨¡å¼
                        </button>
                        <button id="reset-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition text-base">
                            ğŸ”„ é‡æ–°é–‹å§‹
                        </button>
                        <button id="tutorial-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition text-base">
                            ğŸ“– æŸ¥çœ‹æ•™å­¸
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Level Up Modal -->
        <div id="levelup-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
                <div class="text-center">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h3 class="text-2xl font-bold mb-2">ç­‰ç´šæå‡ï¼</h3>
                    <div class="text-5xl font-bold text-primary mb-4" id="levelup-number">2</div>
                    <p class="text-gray-600 dark:text-gray-400 mb-2" id="levelup-desc">æ­å–œä½ å‡ç´šäº†ï¼</p>
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mb-6">
                        <div class="text-sm font-bold mb-2">æ–°åŠŸèƒ½è§£é–ï¼š</div>
                        <div class="text-sm text-gray-700 dark:text-gray-300" id="levelup-unlock"></div>
                    </div>
                    <button onclick="closeLevelUpModal()" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-lg">
                        ç¹¼çºŒ
                    </button>
                </div>
            </div>
        </div>

        <!-- Achievement Modal -->
        <div id="achievement-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
                <div class="text-center">
                    <div class="text-6xl mb-4" id="achievement-icon">ğŸ†</div>
                    <h3 class="text-2xl font-bold mb-2" id="achievement-title">æˆå°±é”æˆï¼</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6" id="achievement-desc">ä½ çœŸæ£’ï¼</p>
                    <button onclick="closeAchievementModal()" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-lg">
                        ç¹¼çºŒ
                    </button>
                </div>
            </div>
        </div>

        <!-- Tutorial Modal -->
        <div id="tutorial-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-2xl w-full p-6 md:p-8 transform transition-all max-h-[90vh] overflow-y-auto">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl md:text-3xl font-bold flex items-center gap-2">
                            <span id="tutorial-icon">ğŸ“–</span>
                            <span id="tutorial-title">éŠæˆ²æ•™å­¸</span>
                        </h3>
                        <div class="text-sm text-gray-500 dark:text-gray-400" id="tutorial-progress">1/7</div>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4">
                        <div id="tutorial-progress-bar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 14.29%"></div>
                    </div>
                </div>

                <div id="tutorial-content" class="mb-6">
                    <!-- Tutorial content will be inserted here -->
                </div>

                <div class="flex justify-between items-center gap-4">
                    <button id="tutorial-skip" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 font-medium py-2 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                        ç•¥éæ•™å­¸
                    </button>
                    <div class="flex gap-3">
                        <button id="tutorial-prev" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                            ä¸Šä¸€æ­¥
                        </button>
                        <button id="tutorial-next" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-lg transition">
                            ä¸‹ä¸€æ­¥
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutorial Highlight Overlay -->
        <div id="tutorial-highlight" class="hidden fixed pointer-events-none z-40" style="box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); border-radius: 8px;"></div>

        <!-- Stage Selection Modal -->
        <div id="stage-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-4xl w-full p-6 md:p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl md:text-3xl font-bold flex items-center gap-2">
                        ğŸ¯ é—œå¡é¸æ“‡
                    </h3>
                    <button onclick="closeStageModal()" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div id="stage-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Stages will be added dynamically -->
                </div>
            </div>
        </div>

        <!-- Stage Complete Modal -->
        <div id="stage-complete-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 md:p-8 transform transition-all">
                <div class="text-center">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h3 class="text-2xl md:text-3xl font-bold mb-4">é—œå¡å®Œæˆï¼</h3>

                    <div class="mb-6">
                        <div class="text-5xl mb-3" id="stage-stars-display">â­â­â­</div>
                        <div class="text-lg font-bold text-gray-700 dark:text-gray-300 mb-2" id="stage-complete-name">é—œå¡ 1</div>
                    </div>

                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-6 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">å®Œæˆæ™‚é–“</span>
                            <span class="font-bold" id="stage-time-result">1:30</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">é…é€æ•¸é‡</span>
                            <span class="font-bold" id="stage-deliveries-result">10</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">æœ€çµ‚è©•åˆ†</span>
                            <span class="font-bold" id="stage-rating-result">5.0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">æ”¶å…¥</span>
                            <span class="font-bold text-green-600" id="stage-money-result">HK$500</span>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="closeStageCompleteModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition text-base">
                            è¿”å›
                        </button>
                        <button id="next-stage-btn" onclick="startNextStage()" class="flex-1 bg-primary hover:bg-primary/90 text-white font-bold py-3 px-4 rounded-lg transition text-base">
                            ä¸‹ä¸€é—œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stage Failed Modal -->
        <div id="stage-failed-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 md:p-8 transform transition-all">
                <div class="text-center">
                    <div class="text-6xl mb-4">ğŸ˜¢</div>
                    <h3 class="text-2xl md:text-3xl font-bold mb-4 text-red-600 dark:text-red-400">é—œå¡å¤±æ•—</h3>

                    <div class="text-gray-700 dark:text-gray-300 mb-6" id="stage-failed-reason">
                        æœªé”æˆç›®æ¨™è¦æ±‚
                    </div>

                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-6 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">å®Œæˆæ™‚é–“</span>
                            <span class="font-bold" id="stage-failed-time">1:30</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">é…é€æ•¸é‡</span>
                            <span class="font-bold" id="stage-failed-deliveries">5/10</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">æœ€çµ‚è©•åˆ†</span>
                            <span class="font-bold" id="stage-failed-rating">4.5</span>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="closeStageFailedModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition text-base">
                            è¿”å›
                        </button>
                        <button onclick="retryStage()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition text-base">
                            é‡è©¦
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Game State
        const gameState = {
            money: 0,
            completed: 0,
            rating: 5.0,
            time: 0,
            level: 1,
            levelProgress: 0,
            isRunning: false,
            currentDelivery: null,
            vanPosition: { x: 10, y: 10 },
            orders: [],
            buildings: [],
            gameTimer: null,
            orderTimer: null,
            unlockedAchievements: new Set(),
            // Stage mode
            stageMode: false,
            currentStage: null,
            stageProgress: {
                unlockedStages: 1,
                stageStars: {} // stageId: stars (1-3)
            }
        };

        // Level configuration
        const levelConfig = {
            1: { target: 10, maxOrders: 3, orderInterval: 8000, timeBonus: 0, rewardMultiplier: 1.0 },
            2: { target: 15, maxOrders: 4, orderInterval: 7000, timeBonus: 5, rewardMultiplier: 1.1 },
            3: { target: 20, maxOrders: 4, orderInterval: 6000, timeBonus: 8, rewardMultiplier: 1.2 },
            4: { target: 25, maxOrders: 5, orderInterval: 5500, timeBonus: 10, rewardMultiplier: 1.3 },
            5: { target: 30, maxOrders: 5, orderInterval: 5000, timeBonus: 12, rewardMultiplier: 1.5 },
            6: { target: 40, maxOrders: 6, orderInterval: 4500, timeBonus: 15, rewardMultiplier: 1.7 },
            7: { target: 50, maxOrders: 6, orderInterval: 4000, timeBonus: 18, rewardMultiplier: 2.0 },
            8: { target: 60, maxOrders: 7, orderInterval: 3500, timeBonus: 20, rewardMultiplier: 2.3 },
            9: { target: 75, maxOrders: 7, orderInterval: 3000, timeBonus: 25, rewardMultiplier: 2.5 },
            10: { target: 100, maxOrders: 8, orderInterval: 2500, timeBonus: 30, rewardMultiplier: 3.0 }
        };

        // Stage configuration
        const stages = [
            {
                id: 1,
                name: 'æ–°æ‰‹è¨“ç·´',
                description: 'å®ŒæˆåŸºæœ¬é…é€è¨“ç·´',
                difficulty: 'ç°¡å–®',
                icon: 'ğŸ¯',
                objectives: {
                    deliveries: 5,
                    timeLimit: 180, // 3 minutes
                    minRating: 4.0
                },
                stars: {
                    bronze: { deliveries: 5, time: 180, rating: 4.0 }, // 1 star
                    silver: { deliveries: 5, time: 150, rating: 4.5 }, // 2 stars
                    gold: { deliveries: 5, time: 120, rating: 4.8 }    // 3 stars
                },
                orderInterval: 8000,
                maxOrders: 2,
                rewardMultiplier: 1.0
            },
            {
                id: 2,
                name: 'åŸå¸‚å¿«é',
                description: 'åœ¨ç¹å¿™çš„åŸå¸‚ä¸­å®Œæˆé…é€',
                difficulty: 'ç°¡å–®',
                icon: 'ğŸ™ï¸',
                objectives: {
                    deliveries: 8,
                    timeLimit: 240,
                    minRating: 4.2
                },
                stars: {
                    bronze: { deliveries: 8, time: 240, rating: 4.2 },
                    silver: { deliveries: 8, time: 200, rating: 4.6 },
                    gold: { deliveries: 8, time: 160, rating: 4.8 }
                },
                orderInterval: 7000,
                maxOrders: 3,
                rewardMultiplier: 1.1
            },
            {
                id: 3,
                name: 'æ™‚é–“æŒ‘æˆ°',
                description: 'åœ¨é™æ™‚å…§å®Œæˆæ›´å¤šé…é€',
                difficulty: 'ä¸­ç­‰',
                icon: 'â±ï¸',
                objectives: {
                    deliveries: 10,
                    timeLimit: 240,
                    minRating: 4.3
                },
                stars: {
                    bronze: { deliveries: 10, time: 240, rating: 4.3 },
                    silver: { deliveries: 10, time: 200, rating: 4.6 },
                    gold: { deliveries: 10, time: 170, rating: 4.9 }
                },
                orderInterval: 6000,
                maxOrders: 3,
                rewardMultiplier: 1.2
            },
            {
                id: 4,
                name: 'å®Œç¾é…é€',
                description: 'ä¿æŒé«˜è©•åˆ†å®Œæˆé…é€',
                difficulty: 'ä¸­ç­‰',
                icon: 'â­',
                objectives: {
                    deliveries: 12,
                    timeLimit: 300,
                    minRating: 4.5
                },
                stars: {
                    bronze: { deliveries: 12, time: 300, rating: 4.5 },
                    silver: { deliveries: 12, time: 250, rating: 4.7 },
                    gold: { deliveries: 12, time: 210, rating: 4.9 }
                },
                orderInterval: 6000,
                maxOrders: 4,
                rewardMultiplier: 1.3
            },
            {
                id: 5,
                name: 'æ•ˆç‡å¤§å¸«',
                description: 'å¿«é€Ÿè™•ç†å¤§é‡è¨‚å–®',
                difficulty: 'ä¸­ç­‰',
                icon: 'ğŸš€',
                objectives: {
                    deliveries: 15,
                    timeLimit: 300,
                    minRating: 4.4
                },
                stars: {
                    bronze: { deliveries: 15, time: 300, rating: 4.4 },
                    silver: { deliveries: 15, time: 260, rating: 4.7 },
                    gold: { deliveries: 15, time: 220, rating: 4.9 }
                },
                orderInterval: 5500,
                maxOrders: 4,
                rewardMultiplier: 1.4
            },
            {
                id: 6,
                name: 'å¤œé–“å¿«é',
                description: 'åœ¨å¤œé–“å®Œæˆç·Šæ€¥é…é€',
                difficulty: 'å›°é›£',
                icon: 'ğŸŒ™',
                objectives: {
                    deliveries: 18,
                    timeLimit: 360,
                    minRating: 4.5
                },
                stars: {
                    bronze: { deliveries: 18, time: 360, rating: 4.5 },
                    silver: { deliveries: 18, time: 300, rating: 4.7 },
                    gold: { deliveries: 18, time: 250, rating: 4.9 }
                },
                orderInterval: 5000,
                maxOrders: 5,
                rewardMultiplier: 1.6
            },
            {
                id: 7,
                name: 'æ¥µé€Ÿç‹‚é£†',
                description: 'æ¥µé™é€Ÿåº¦æŒ‘æˆ°',
                difficulty: 'å›°é›£',
                icon: 'âš¡',
                objectives: {
                    deliveries: 20,
                    timeLimit: 300,
                    minRating: 4.6
                },
                stars: {
                    bronze: { deliveries: 20, time: 300, rating: 4.6 },
                    silver: { deliveries: 20, time: 260, rating: 4.8 },
                    gold: { deliveries: 20, time: 220, rating: 4.9 }
                },
                orderInterval: 4500,
                maxOrders: 5,
                rewardMultiplier: 1.8
            },
            {
                id: 8,
                name: 'é…é€ä¹‹ç‹',
                description: 'è­‰æ˜ä½ æ˜¯æœ€å¼·é€è²¨å“¡',
                difficulty: 'å›°é›£',
                icon: 'ğŸ‘‘',
                objectives: {
                    deliveries: 25,
                    timeLimit: 360,
                    minRating: 4.7
                },
                stars: {
                    bronze: { deliveries: 25, time: 360, rating: 4.7 },
                    silver: { deliveries: 25, time: 310, rating: 4.8 },
                    gold: { deliveries: 25, time: 270, rating: 4.95 }
                },
                orderInterval: 4000,
                maxOrders: 6,
                rewardMultiplier: 2.0
            },
            {
                id: 9,
                name: 'å‚³èªªæŒ‘æˆ°',
                description: 'åªæœ‰å‚³å¥‡æ‰èƒ½å®Œæˆ',
                difficulty: 'å°ˆå®¶',
                icon: 'ğŸ†',
                objectives: {
                    deliveries: 30,
                    timeLimit: 420,
                    minRating: 4.8
                },
                stars: {
                    bronze: { deliveries: 30, time: 420, rating: 4.8 },
                    silver: { deliveries: 30, time: 360, rating: 4.85 },
                    gold: { deliveries: 30, time: 310, rating: 4.95 }
                },
                orderInterval: 3500,
                maxOrders: 6,
                rewardMultiplier: 2.5
            },
            {
                id: 10,
                name: 'çµ‚æ¥µè©¦ç…‰',
                description: 'æœ€çµ‚çš„æ¥µé™æŒ‘æˆ°',
                difficulty: 'å°ˆå®¶',
                icon: 'ğŸ’',
                objectives: {
                    deliveries: 40,
                    timeLimit: 480,
                    minRating: 4.85
                },
                stars: {
                    bronze: { deliveries: 40, time: 480, rating: 4.85 },
                    silver: { deliveries: 40, time: 420, rating: 4.9 },
                    gold: { deliveries: 40, time: 360, rating: 4.95 }
                },
                orderInterval: 3000,
                maxOrders: 7,
                rewardMultiplier: 3.0
            }
        ];

        // Building locations and names
        const buildingLocations = [
            { x: 15, y: 20, name: 'ğŸ“ Aæ£Ÿå…¬å¯“', emoji: 'ğŸ¢' },
            { x: 40, y: 20, name: 'ğŸ“ Bæ£Ÿå…¬å¯“', emoji: 'ğŸ¢' },
            { x: 65, y: 20, name: 'ğŸ“ Cæ£Ÿå…¬å¯“', emoji: 'ğŸ¢' },
            { x: 90, y: 20, name: 'ğŸ“ è¶…ç´šå¸‚å ´', emoji: 'ğŸª' },
            { x: 15, y: 45, name: 'ğŸ“ å­¸æ ¡', emoji: 'ğŸ«' },
            { x: 40, y: 45, name: 'ğŸ“ é†«é™¢', emoji: 'ğŸ¥' },
            { x: 65, y: 45, name: 'ğŸ“ é¤å»³', emoji: 'ğŸ½ï¸' },
            { x: 90, y: 45, name: 'ğŸ“ è¾¦å…¬æ¨“', emoji: 'ğŸ¢' },
            { x: 15, y: 70, name: 'ğŸ“ é…’åº—', emoji: 'ğŸ¨' },
            { x: 40, y: 70, name: 'ğŸ“ åœ–æ›¸é¤¨', emoji: 'ğŸ“š' },
            { x: 65, y: 70, name: 'ğŸ“ å’–å•¡é¤¨', emoji: 'â˜•' },
            { x: 90, y: 70, name: 'ğŸ“ å¥èº«æˆ¿', emoji: 'ğŸ’ª' }
        ];

        // Get current level config
        function getCurrentLevelConfig() {
            return levelConfig[gameState.level] || levelConfig[10];
        }

        // Check and handle level up
        function checkLevelUp() {
            const config = getCurrentLevelConfig();
            if (gameState.levelProgress >= config.target && gameState.level < 10) {
                gameState.level++;
                gameState.levelProgress = 0;
                showLevelUp();
                updateLevelDisplay();

                // Restart order timer with new interval
                if (gameState.orderTimer) {
                    clearInterval(gameState.orderTimer);
                    startOrderTimer();
                }
            }
        }

        // Show level up modal
        function showLevelUp() {
            const newLevel = gameState.level;
            const config = getCurrentLevelConfig();
            const unlocks = [];

            if (newLevel === 2) unlocks.push('åŒæ™‚é¡¯ç¤ºæ›´å¤šè¨‚å–®');
            if (newLevel === 3) unlocks.push('è¨‚å–®çå‹µæå‡ 20%');
            if (newLevel === 4) unlocks.push('è¨‚å–®åˆ·æ–°é€Ÿåº¦åŠ å¿«');
            if (newLevel === 5) unlocks.push('çå‹µé‡‘é¡æå‡è‡³ 1.5 å€');
            if (newLevel === 6) unlocks.push('é¡å¤–è¨‚å–®ä½ç½®');
            if (newLevel === 7) unlocks.push('çå‹µé‡‘é¡æå‡è‡³ 2 å€');
            if (newLevel === 8) unlocks.push('æ›´å¤šè¨‚å–®ä½ç½®');
            if (newLevel === 9) unlocks.push('è¨‚å–®çå‹µæå‡ 2.5 å€');
            if (newLevel === 10) unlocks.push('æœ€é«˜çå‹µå€ç‡ 3 å€ï¼');

            document.getElementById('levelup-number').textContent = `ç­‰ç´š ${newLevel}`;
            document.getElementById('levelup-desc').textContent = `ä½ å·²å‡è‡³ç­‰ç´š ${newLevel}ï¼`;
            document.getElementById('levelup-unlock').innerHTML = unlocks.map(u => `â€¢ ${u}`).join('<br>');
            document.getElementById('levelup-modal').classList.remove('hidden');

            // Add animation to level display
            const levelElement = document.getElementById('level');
            levelElement.classList.add('level-up-animation');
            setTimeout(() => levelElement.classList.remove('level-up-animation'), 500);
        }

        // Close level up modal
        function closeLevelUpModal() {
            document.getElementById('levelup-modal').classList.add('hidden');
        }

        // Update level display
        function updateLevelDisplay() {
            const config = getCurrentLevelConfig();
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('level-progress').textContent = gameState.levelProgress;
            document.getElementById('level-target').textContent = config.target;
        }

        // Initialize buildings
        function initBuildings() {
            const buildingsContainer = document.getElementById('buildings');
            buildingsContainer.innerHTML = '';
            gameState.buildings = [];

            buildingLocations.forEach((loc, index) => {
                const building = document.createElement('div');
                building.className = 'building absolute cursor-pointer';
                building.style.left = `${loc.x}%`;
                building.style.top = `${loc.y}%`;
                building.innerHTML = `
                    <div class="text-3xl">${loc.emoji}</div>
                    <div class="text-xs text-center mt-1 bg-white/80 dark:bg-gray-800/80 px-2 py-1 rounded whitespace-nowrap">${loc.name.replace('ğŸ“ ', '')}</div>
                `;
                building.onclick = () => deliverToBuilding(index);
                buildingsContainer.appendChild(building);
                gameState.buildings.push({ ...loc, element: building });
            });
        }

        // Generate random order
        function generateOrder() {
            const availableBuildings = gameState.buildings.filter((b, i) =>
                !gameState.orders.some(o => o.destination === i) &&
                (!gameState.currentDelivery || gameState.currentDelivery.destination !== i)
            );

            if (availableBuildings.length === 0) return;

            const randomBuilding = availableBuildings[Math.floor(Math.random() * availableBuildings.length)];
            const buildingIndex = gameState.buildings.findIndex(b => b === randomBuilding);

            const items = ['ğŸ“¦ åŒ…è£¹', 'ğŸ• å¤–è³£', 'ğŸ“„ æ–‡ä»¶', 'ğŸ ç¦®ç‰©', 'ğŸ›ï¸ è³¼ç‰©', 'ğŸ’ é®®èŠ±'];
            const item = items[Math.floor(Math.random() * items.length)];

            const config = getCurrentLevelConfig();
            const baseReward = Math.floor(Math.random() * 30) + 20;
            const reward = Math.floor(baseReward * config.rewardMultiplier);

            // Time limit decreases slightly with level but not too much
            const baseTime = Math.floor(Math.random() * 30) + 30;
            const timeLimit = Math.max(20, baseTime - Math.floor(gameState.level / 2) * 2);

            const order = {
                id: Date.now() + Math.random(),
                item,
                destination: buildingIndex,
                destinationName: randomBuilding.name,
                reward,
                timeLimit,
                timeRemaining: timeLimit
            };

            gameState.orders.push(order);
            renderOrders();
        }

        // Render orders
        function renderOrders() {
            const ordersContainer = document.getElementById('orders');
            ordersContainer.innerHTML = '';

            if (gameState.orders.length === 0) {
                ordersContainer.innerHTML = '<div class="text-sm text-gray-500 dark:text-gray-400">æš«ç„¡æ–°è¨‚å–®...</div>';
                return;
            }

            gameState.orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card bg-white dark:bg-gray-700 rounded-lg p-3 shadow cursor-pointer hover:shadow-lg';
                orderCard.onclick = () => acceptOrder(order.id);

                const urgencyColor = order.timeRemaining < 20 ? 'text-red-500' : order.timeRemaining < 40 ? 'text-yellow-500' : 'text-green-500';

                orderCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold">${order.item}</div>
                        <div class="text-green-600 dark:text-green-400 font-bold">HK$${order.reward}</div>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">${order.destinationName}</div>
                    <div class="text-xs ${urgencyColor} font-bold">â±ï¸ ${order.timeRemaining}ç§’</div>
                `;
                ordersContainer.appendChild(orderCard);
            });
        }

        // Accept order
        function acceptOrder(orderId) {
            if (gameState.currentDelivery) {
                showNotification('âš ï¸ è«‹å…ˆå®Œæˆç•¶å‰é…é€ï¼', 'warning');
                return;
            }

            const orderIndex = gameState.orders.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return;

            gameState.currentDelivery = gameState.orders.splice(orderIndex, 1)[0];
            renderOrders();
            updateCurrentDelivery();

            // Highlight destination
            gameState.buildings[gameState.currentDelivery.destination].element.classList.add('ring-4', 'ring-primary', 'ring-offset-2');

            showNotification('âœ… è¨‚å–®å·²æ¥å—ï¼Œå‰å¾€ç›®çš„åœ°ï¼', 'success');
        }

        // Update current delivery display
        function updateCurrentDelivery() {
            const currentDeliveryDiv = document.getElementById('current-delivery');

            if (!gameState.currentDelivery) {
                currentDeliveryDiv.innerHTML = '<div class="text-gray-500 dark:text-gray-400">æš«ç„¡é…é€ä»»å‹™</div>';
                return;
            }

            const delivery = gameState.currentDelivery;
            const urgencyColor = delivery.timeRemaining < 20 ? 'text-red-500' : delivery.timeRemaining < 40 ? 'text-yellow-500' : 'text-green-500';

            currentDeliveryDiv.innerHTML = `
                <div class="bg-white dark:bg-gray-700 rounded-lg p-3 shadow">
                    <div class="font-bold mb-2">${delivery.item}</div>
                    <div class="text-sm mb-1">${delivery.destinationName}</div>
                    <div class="text-sm mb-2">çå‹µ: <span class="text-green-600 dark:text-green-400 font-bold">HK$${delivery.reward}</span></div>
                    <div class="text-sm ${urgencyColor} font-bold">å‰©é¤˜: ${delivery.timeRemaining}ç§’</div>
                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">é»æ“Šåœ°åœ–ä¸Šçš„å»ºç¯‰ç‰©å®Œæˆé…é€</div>
                </div>
            `;
        }

        // Deliver to building
        function deliverToBuilding(buildingIndex) {
            if (!gameState.currentDelivery) {
                showNotification('ğŸ’¡ è«‹å…ˆæ¥å—è¨‚å–®ï¼', 'info');
                return;
            }

            if (gameState.currentDelivery.destination !== buildingIndex) {
                showNotification('âŒ é€™ä¸æ˜¯æ­£ç¢ºçš„ç›®çš„åœ°ï¼', 'error');
                return;
            }

            // Move van to building
            const building = gameState.buildings[buildingIndex];
            moveVan(building.x, building.y);

            // Complete delivery after animation
            setTimeout(() => {
                completeDelivery();
            }, 600);
        }

        // Move van
        function moveVan(x, y) {
            const van = document.getElementById('van');
            van.style.left = `${x}%`;
            van.style.top = `${y}%`;
            gameState.vanPosition = { x, y };
            document.getElementById('position').textContent = `ä½ç½®: é…é€ä¸­...`;
        }

        // Complete delivery
        function completeDelivery() {
            if (!gameState.currentDelivery) return;

            const delivery = gameState.currentDelivery;
            let bonus = delivery.reward;
            let ratingChange = 0;

            // Calculate bonus based on time
            if (delivery.timeRemaining > delivery.timeLimit * 0.7) {
                bonus = Math.floor(bonus * 1.5);
                ratingChange = 0.1;
                showNotification('ğŸŒŸ æº–æ™‚é€é”ï¼ç²å¾—çå‹µï¼', 'success');
            } else if (delivery.timeRemaining > 0) {
                showNotification('âœ… é…é€å®Œæˆï¼', 'success');
            } else {
                bonus = Math.floor(bonus * 0.5);
                ratingChange = -0.2;
                showNotification('âš ï¸ è¶…æ™‚é€é”ï¼Œçå‹µæ¸›åŠ', 'warning');
            }

            // Update stats
            gameState.money += bonus;
            gameState.completed++;
            gameState.levelProgress++;
            gameState.rating = Math.max(1, Math.min(5, gameState.rating + ratingChange));

            // Remove highlight
            gameState.buildings[delivery.destination].element.classList.remove('ring-4', 'ring-primary', 'ring-offset-2');

            gameState.currentDelivery = null;
            updateStats();
            updateLevelDisplay();
            updateCurrentDelivery();
            checkLevelUp();

            // Return to warehouse
            setTimeout(() => {
                moveVan(10, 10);
                document.getElementById('position').textContent = 'ä½ç½®: å€‰åº«';
            }, 500);

            // Check achievements
            checkAchievements();
        }

        // Update stats display
        function updateStats() {
            document.getElementById('money').textContent = `HK$${gameState.money}`;
            document.getElementById('completed').textContent = gameState.completed;
            document.getElementById('rating').textContent = gameState.rating.toFixed(1);
        }

        // Update game time
        function updateTime() {
            const minutes = Math.floor(gameState.time / 60);
            const seconds = gameState.time % 60;
            document.getElementById('time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-bold z-50 transform transition-all duration-300`;

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            notification.classList.add(colors[type] || colors.info);
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Check achievements
        function checkAchievements() {
            const achievements = [
                { id: 'newbie', threshold: 5, icon: 'ğŸ¯', title: 'æ–°æ‰‹å¸æ©Ÿ', desc: 'å®Œæˆ5æ¬¡é…é€ï¼' },
                { id: 'expert', threshold: 10, icon: 'ğŸš€', title: 'é…é€é”äºº', desc: 'å®Œæˆ10æ¬¡é…é€ï¼' },
                { id: 'master', threshold: 20, icon: 'ğŸ‘‘', title: 'é…é€ä¹‹ç‹', desc: 'å®Œæˆ20æ¬¡é…é€ï¼' },
                { id: 'legend', threshold: 50, icon: 'ğŸ†', title: 'å‚³å¥‡é€è²¨å“¡', desc: 'å®Œæˆ50æ¬¡é…é€ï¼' },
                { id: 'god', threshold: 100, icon: 'âš¡', title: 'é…é€ä¹‹ç¥', desc: 'å®Œæˆ100æ¬¡é…é€ï¼' }
            ];

            achievements.forEach(ach => {
                if (gameState.completed === ach.threshold && !gameState.unlockedAchievements.has(ach.id)) {
                    gameState.unlockedAchievements.add(ach.id);
                    showAchievement(ach.icon, ach.title, ach.desc);
                }
            });

            if (gameState.money >= 500 && !gameState.unlockedAchievements.has('money500')) {
                gameState.unlockedAchievements.add('money500');
                showAchievement('ğŸ’°', 'å°æœ‰æˆå°±', 'è³ºå– HK$500ï¼');
            }

            if (gameState.money >= 2000 && !gameState.unlockedAchievements.has('money2000')) {
                gameState.unlockedAchievements.add('money2000');
                showAchievement('ğŸ’', 'å¯Œæœ‰é€è²¨å“¡', 'è³ºå– HK$2000ï¼');
            }

            if (gameState.rating >= 4.8 && gameState.completed >= 10 && !gameState.unlockedAchievements.has('rating')) {
                gameState.unlockedAchievements.add('rating');
                showAchievement('â­', 'äº”æ˜Ÿå¥½è©•', 'ä¿æŒé«˜è©•åˆ†ï¼');
            }

            if (gameState.level >= 5 && !gameState.unlockedAchievements.has('level5')) {
                gameState.unlockedAchievements.add('level5');
                showAchievement('ğŸ”¥', 'æ™‰ç´šé«˜æ‰‹', 'é”åˆ°ç­‰ç´š 5ï¼');
            }

            if (gameState.level >= 10 && !gameState.unlockedAchievements.has('level10')) {
                gameState.unlockedAchievements.add('level10');
                showAchievement('ğŸŒŸ', 'æ»¿ç´šå¤§å¸«', 'é”åˆ°ç­‰ç´š 10ï¼');
            }
        }

        // Show achievement modal
        function showAchievement(icon, title, desc) {
            document.getElementById('achievement-icon').textContent = icon;
            document.getElementById('achievement-title').textContent = title;
            document.getElementById('achievement-desc').textContent = desc;
            document.getElementById('achievement-modal').classList.remove('hidden');
        }

        // Close achievement modal
        function closeAchievementModal() {
            document.getElementById('achievement-modal').classList.add('hidden');
        }

        // Start order generation timer
        function startOrderTimer() {
            const config = getCurrentLevelConfig();
            gameState.orderTimer = setInterval(() => {
                if (gameState.orders.length < config.maxOrders) {
                    generateOrder();
                }
            }, config.orderInterval);
        }

        // Start game
        function startGame() {
            if (gameState.isRunning) return;

            gameState.isRunning = true;
            document.getElementById('start-btn').textContent = 'â¸ï¸ éŠæˆ²é€²è¡Œä¸­...';
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').classList.add('opacity-50', 'cursor-not-allowed');

            // Game timer
            gameState.gameTimer = setInterval(() => {
                gameState.time++;
                updateTime();

                // Update order timers
                gameState.orders.forEach(order => {
                    order.timeRemaining--;
                    if (order.timeRemaining <= 0) {
                        gameState.orders = gameState.orders.filter(o => o.id !== order.id);
                        showNotification('ğŸ“¦ è¨‚å–®å·²å–æ¶ˆï¼ˆè¶…æ™‚ï¼‰', 'warning');
                    }
                });

                // Update current delivery timer
                if (gameState.currentDelivery) {
                    gameState.currentDelivery.timeRemaining--;
                    updateCurrentDelivery();
                }

                renderOrders();
            }, 1000);

            // Start order generation
            startOrderTimer();

            // Generate initial orders
            generateOrder();
            setTimeout(() => generateOrder(), 3000);

            showNotification('ğŸ® éŠæˆ²é–‹å§‹ï¼æ¥å—è¨‚å–®é–‹å§‹é…é€å§ï¼', 'success');
        }

        // Reset game
        function resetGame() {
            // Clear timers
            if (gameState.gameTimer) clearInterval(gameState.gameTimer);
            if (gameState.orderTimer) clearInterval(gameState.orderTimer);

            // Remove highlights
            gameState.buildings.forEach(b => {
                b.element.classList.remove('ring-4', 'ring-primary', 'ring-offset-2');
            });

            // Reset state (but keep stage progress)
            gameState.money = 0;
            gameState.completed = 0;
            gameState.rating = 5.0;
            gameState.time = 0;
            gameState.level = 1;
            gameState.levelProgress = 0;
            gameState.isRunning = false;
            gameState.currentDelivery = null;
            gameState.orders = [];

            // Only reset achievements in free mode
            if (!gameState.stageMode) {
                gameState.unlockedAchievements.clear();
            }

            // Reset van position
            moveVan(10, 10);
            document.getElementById('position').textContent = 'ä½ç½®: å€‰åº«';

            // Reset UI to normal mode
            document.getElementById('stage-info').classList.add('hidden');
            document.getElementById('level-info').classList.remove('hidden');
            document.getElementById('game-mode-text').textContent = 'æˆç‚ºæœ€ä½³é€è²¨å“¡ï¼æº–æ™‚é€é”ï¼Œè³ºå–æ”¶å…¥ï¼';

            // Update UI
            updateStats();
            updateTime();
            updateLevelDisplay();
            renderOrders();
            updateCurrentDelivery();

            document.getElementById('start-btn').textContent = 'ğŸ® è‡ªç”±æ¨¡å¼';
            document.getElementById('start-btn').disabled = false;
            document.getElementById('start-btn').classList.remove('opacity-50', 'cursor-not-allowed');

            // Reset stage mode flag
            gameState.stageMode = false;
            gameState.currentStage = null;

            if (!gameState.stageMode) {
                showNotification('ğŸ”„ éŠæˆ²å·²é‡ç½®', 'info');
            }
        }

        // Tutorial System
        const tutorialSteps = [
            {
                icon: 'ğŸ‘‹',
                title: 'æ­¡è¿ä¾†åˆ°é€è²¨æ¨¡æ“¬å™¨ï¼',
                content: `
                    <div class="space-y-4">
                        <p class="text-lg">æ­¡è¿æˆç‚ºä¸€åé€è²¨å“¡ï¼åœ¨é€™å€‹éŠæˆ²ä¸­ï¼Œä½ éœ€è¦ï¼š</p>
                        <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
                            <li>æ¥å—å®¢æˆ¶çš„é…é€è¨‚å–®</li>
                            <li>å°‡åŒ…è£¹æº–æ™‚é€åˆ°æŒ‡å®šåœ°é»</li>
                            <li>è³ºå–æ”¶å…¥ä¸¦æå‡ä½ çš„è©•åˆ†</li>
                            <li>å‡ç´šä»¥è§£é–æ›´å¤šåŠŸèƒ½å’Œçå‹µ</li>
                            <li>æˆç‚ºåŸå¸‚ä¸­æœ€å„ªç§€çš„é€è²¨å“¡ï¼</li>
                        </ul>
                        <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <p class="text-sm text-blue-800 dark:text-blue-200">ğŸ’¡ <strong>æç¤ºï¼š</strong>æœ¬æ•™å­¸å°‡å¸¶ä½ äº†è§£éŠæˆ²çš„ï¿½ï¿½ï¿½æœ¬æ“ä½œ</p>
                        </div>
                    </div>
                `,
                highlight: null
            },
            {
                icon: 'â­',
                title: 'ç­‰ç´šç³»çµ±',
                content: `
                    <div class="space-y-4">
                        <p class="text-lg mb-3">éŠæˆ²è¨­æœ‰ç­‰ç´šç³»çµ±ï¼Œè®“ä½ ä¸æ–·é€²æ­¥ï¼š</p>
                        <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
                            <li><strong>å®Œæˆé…é€æå‡ç­‰ç´šï¼š</strong>æ¯å®Œæˆä¸€æ¬¡é…é€ç²å¾—ç¶“é©—</li>
                            <li><strong>è§£é–æ›´é«˜æ”¶ç›Šï¼š</strong>ç­‰ç´šè¶Šé«˜ï¼Œè¨‚å–®çå‹µè¶Šè±åš</li>
                            <li><strong>æ›´å¤šè¨‚å–®ä½ç½®ï¼š</strong>é«˜ç­‰ç´šå¯åŒæ™‚è™•ç†æ›´å¤šè¨‚å–®</li>
                            <li><strong>æŒ‘æˆ°æ›´å¿«ç¯€å¥ï¼š</strong>è¨‚å–®åˆ·æ–°é€Ÿåº¦éš¨ç­‰ç´šåŠ å¿«</li>
                        </ul>
                        <div class="mt-4 p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                            <div class="text-sm text-purple-800 dark:text-purple-200 mb-2">
                                <strong>ç­‰ç´šçå‹µç¯„ä¾‹ï¼š</strong>
                            </div>
                            <div class="text-xs text-gray-700 dark:text-gray-300 space-y-1">
                                <div>â€¢ ç­‰ç´š 1: åŸºæœ¬çå‹µ</div>
                                <div>â€¢ ç­‰ç´š 5: çå‹µæå‡ 50%</div>
                                <div>â€¢ ç­‰ç´š 10: çå‹µæå‡ 200%ï¼</div>
                            </div>
                        </div>
                    </div>
                `,
                highlight: '#level'
            },
            {
                icon: 'ğŸ“Š',
                title: 'äº†è§£éŠæˆ²ä»‹é¢',
                content: `
                    <div class="space-y-4">
                        <p class="text-lg mb-4">éŠæˆ²ä»‹é¢åˆ†ç‚ºå¹¾å€‹é‡è¦å€åŸŸï¼š</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="font-bold mb-1">ğŸ’° æ”¶å…¥</div>
                                <p class="text-sm text-gray-700 dark:text-gray-300">é¡¯ç¤ºä½ ç•¶å‰è³ºå–çš„ç¸½é‡‘é¡</p>
                            </div>
                            <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="font-bold mb-1">ğŸ“¦ å·²å®Œæˆ</div>
                                <p class="text-sm text-gray-700 dark:text-gray-300">ä½ å®Œæˆçš„é…é€è¨‚å–®æ•¸é‡</p>
                            </div>
                            <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                <div class="font-bold mb-1">â­ è©•åˆ†</div>
                                <p class="text-sm text-gray-700 dark:text-gray-300">ä½ çš„æœå‹™è©•åˆ†ï¼ˆ1-5æ˜Ÿï¼‰</p>
                            </div>
                            <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                <div class="font-bold mb-1">â±ï¸ æ™‚é–“</div>
                                <p class="text-sm text-gray-700 dark:text-gray-300">éŠæˆ²é€²è¡Œçš„æ™‚é•·</p>
                            </div>
                        </div>
                    </div>
                `,
                highlight: '.max-w-7xl > .grid.grid-cols-2'
            },
            {
                icon: 'ğŸ—ºï¸',
                title: 'é…é€å€åŸŸåœ°åœ–',
                content: `
                    <div class="space-y-4">
                        <p class="text-lg">åœ°åœ–ä¸Šé¡¯ç¤ºäº†æ‰€æœ‰å¯é…é€çš„å»ºç¯‰ç‰©ï¼š</p>
                        <div class="space-y-2 text-gray-700 dark:text-gray-300">
                            <p>ğŸ¢ <strong>å»ºç¯‰ç‰©ï¼š</strong>åŒ…æ‹¬å…¬å¯“ã€è¶…å¸‚ã€å­¸æ ¡ã€é†«é™¢ç­‰å¤šå€‹åœ°é»</p>
                            <p>ğŸšš <strong>é€è²¨è»Šï¼š</strong>ä½ æ§åˆ¶çš„é…é€è»Šè¼›ï¼Œç•¶å‰åœåœ¨å€‰åº«</p>
                            <p>ğŸ›£ï¸ <strong>é“è·¯ç¶²çµ¡ï¼š</strong>é€£æ¥å„å€‹å»ºç¯‰çš„é“è·¯ç³»çµ±</p>
                        </div>
                        <div class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                            <p class="text-sm text-yellow-800 dark:text-yellow-200">ğŸ’¡ <strong>æ“ä½œæ–¹æ³•ï¼š</strong>é»æ“Šåœ°åœ–ä¸Šçš„å»ºç¯‰ç‰©å³å¯å®Œæˆé…é€ï¼</p>
                        </div>
                    </div>
                `,
                highlight: '#map'
            },
            {
                icon: 'ğŸ“‹',
                title: 'æ¥å—è¨‚å–®',
                content: `
                    <div class="space-y-4">
                        <p class="text-lg">éŠæˆ²é–‹å§‹å¾Œï¼Œè¨‚å–®æœƒè‡ªå‹•å‡ºç¾åœ¨è¨‚å–®åˆ—è¡¨ä¸­ï¼š</p>
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-3">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-bold">ğŸ“¦ åŒ…è£¹</div>
                                <div class="text-green-600 dark:text-green-400 font-bold">HK$45</div>
                            </div>
                            <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">ğŸ“ Aæ£Ÿå…¬å¯“</div>
                            <div class="text-xs text-green-500 font-bold">â±ï¸ 50ç§’</div>
                        </div>
                        <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
                            <li><strong>ç‰©å“é¡å‹ï¼š</strong>é¡¯ç¤ºè¦é…é€çš„ç‰©å“</li>
                            <li><strong>çå‹µé‡‘é¡ï¼š</strong>å®Œæˆé…é€å¾Œç²å¾—çš„æ”¶å…¥</li>
                            <li><strong>ç›®çš„åœ°ï¼š</strong>éœ€è¦é…é€åˆ°çš„å»ºç¯‰ç‰©</li>
                            <li><strong>å‰©é¤˜æ™‚é–“ï¼š</strong>å¿…é ˆåœ¨æ™‚é–“å…§å®Œæˆ</li>
                        </ul>
                        <div class="mt-4 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                            <p class="text-sm text-green-800 dark:text-green-200">âœ… <strong>é»æ“Šè¨‚å–®å¡ç‰‡</strong>å³å¯æ¥å—è¨‚å–®é–‹å§‹é…é€ï¼</p>
                        </div>
                    </div>
                `,
                highlight: '#orders'
            },
            {
                icon: 'ğŸš€',
                title: 'å®Œæˆé…é€',
                content: `
                    <div class="space-y-4">
                        <p class="text-lg mb-3">æ¥å—è¨‚å–®å¾Œï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå®Œæˆé…é€ï¼š</p>
                        <div class="space-y-3">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center font-bold">1</div>
                                <div>
                                    <div class="font-bold mb-1">æ¥å—è¨‚å–®</div>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">é»æ“Šå¾…æ¥è¨‚å–®åˆ—è¡¨ä¸­çš„è¨‚å–®å¡ç‰‡</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center font-bold">2</div>
                                <div>
                                    <div class="font-bold mb-1">æ‰¾åˆ°ç›®çš„åœ°</div>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">ç›®æ¨™å»ºç¯‰æœƒåœ¨åœ°åœ–ä¸Šé«˜äº®é¡¯ç¤º</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center font-bold">3</div>
                                <div>
                                    <div class="font-bold mb-1">é»æ“Šå»ºç¯‰</div>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">é»æ“Šé«˜äº®çš„ç›®æ¨™å»ºç¯‰ç‰©å®Œæˆé…é€</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                            <p class="text-sm text-purple-800 dark:text-purple-200">âš¡ <strong>æº–æ™‚é€é”</strong>å¯ç²å¾—é¡å¤–çå‹µå’Œè©•åˆ†åŠ æˆï¼</p>
                        </div>
                    </div>
                `,
                highlight: '#current-delivery'
            },
            {
                icon: 'ğŸ†',
                title: 'éŠæˆ²æŠ€å·§èˆ‡æˆå°±',
                content: `
                    <div class="space-y-4">
                        <p class="text-lg mb-3"><strong>éŠæˆ²æŠ€å·§ï¼š</strong></p>
                        <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
                            <li><strong>å„ªå…ˆè™•ç†ç·Šæ€¥è¨‚å–®ï¼š</strong>å‰©é¤˜æ™‚é–“å°‘çš„è¨‚å–®å„ªå…ˆå®Œæˆ</li>
                            <li><strong>è¦åŠƒé…é€è·¯ç·šï¼š</strong>é¸æ“‡è·é›¢è¿‘çš„è¨‚å–®å¯ç¯€çœæ™‚é–“</li>
                            <li><strong>æº–æ™‚é€é”ï¼š</strong>åœ¨70%æ™‚é–“å…§å®Œæˆå¯ç²å¾—1.5å€çå‹µ</li>
                            <li><strong>è¶…æ™‚æ‡²ç½°ï¼š</strong>è¶…æ™‚é€é”çå‹µæ¸›åŠï¼Œè©•åˆ†ä¸‹é™</li>
                            <li><strong>æŒçºŒå‡ç´šï¼š</strong>ç­‰ç´šè¶Šé«˜æ”¶ç›Šè¶Šå¥½</li>
                        </ul>
                        <p class="text-lg mt-4 mb-3"><strong>æˆå°±ç³»çµ±ï¼š</strong></p>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="p-3 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-lg">
                                <p class="text-sm">ğŸ¯ <strong>æ–°æ‰‹å¸æ©Ÿï¼š</strong>å®Œæˆ5æ¬¡é…é€</p>
                            </div>
                            <div class="p-3 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg">
                                <p class="text-sm">ğŸš€ <strong>é…é€é”äººï¼š</strong>å®Œæˆ10æ¬¡é…é€</p>
                            </div>
                            <div class="p-3 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-lg">
                                <p class="text-sm">ğŸ’° <strong>å°æœ‰æˆå°±ï¼š</strong>è³ºå– HK$500</p>
                            </div>
                            <div class="p-3 bg-gradient-to-r from-green-50 to-teal-50 dark:from-green-900/20 dark:to-teal-900/20 rounded-lg">
                                <p class="text-sm">ğŸŒŸ <strong>æ»¿ç´šå¤§å¸«ï¼š</strong>é”åˆ°ç­‰ç´š 10</p>
                            </div>
                        </div>
                        <div class="mt-6 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg text-center">
                            <p class="text-lg font-bold text-green-800 dark:text-green-200">ğŸ® æº–å‚™å¥½é–‹å§‹éŠæˆ²äº†å—ï¼Ÿ</p>
                            <p class="text-sm text-gray-700 dark:text-gray-300 mt-2">é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€æŒ‰éˆ•é–‹å§‹ä½ çš„é€è²¨ä¹‹æ—…ï¼</p>
                        </div>
                    </div>
                `,
                highlight: null
            }
        ];

        let currentTutorialStep = 0;
        let tutorialActive = false;

        function showTutorial() {
            tutorialActive = true;
            currentTutorialStep = 0;
            document.getElementById('tutorial-modal').classList.remove('hidden');
            updateTutorialStep();
        }

        function closeTutorial() {
            tutorialActive = false;
            document.getElementById('tutorial-modal').classList.add('hidden');
            document.getElementById('tutorial-highlight').classList.add('hidden');
        }

        function updateTutorialStep() {
            const step = tutorialSteps[currentTutorialStep];
            const totalSteps = tutorialSteps.length;
            const progress = ((currentTutorialStep + 1) / totalSteps) * 100;

            // Update content
            document.getElementById('tutorial-icon').textContent = step.icon;
            document.getElementById('tutorial-title').textContent = step.title;
            document.getElementById('tutorial-content').innerHTML = step.content;
            document.getElementById('tutorial-progress').textContent = `${currentTutorialStep + 1}/${totalSteps}`;
            document.getElementById('tutorial-progress-bar').style.width = `${progress}%`;

            // Update buttons
            const prevBtn = document.getElementById('tutorial-prev');
            const nextBtn = document.getElementById('tutorial-next');

            prevBtn.disabled = currentTutorialStep === 0;

            if (currentTutorialStep === totalSteps - 1) {
                nextBtn.textContent = 'é–‹å§‹éŠæˆ²';
            } else {
                nextBtn.textContent = 'ä¸‹ä¸€æ­¥';
            }

            // Update highlight
            updateTutorialHighlight(step.highlight);
        }

        function updateTutorialHighlight(selector) {
            const highlight = document.getElementById('tutorial-highlight');

            if (!selector) {
                highlight.classList.add('hidden');
                return;
            }

            const element = document.querySelector(selector);
            if (!element) {
                highlight.classList.add('hidden');
                return;
            }

            const rect = element.getBoundingClientRect();
            highlight.style.left = rect.left + 'px';
            highlight.style.top = rect.top + 'px';
            highlight.style.width = rect.width + 'px';
            highlight.style.height = rect.height + 'px';
            highlight.classList.remove('hidden');
        }

        function nextTutorialStep() {
            if (currentTutorialStep < tutorialSteps.length - 1) {
                currentTutorialStep++;
                updateTutorialStep();
            } else {
                // Last step - close tutorial and start game
                closeTutorial();
                if (!gameState.isRunning) {
                    startGame();
                }
            }
        }

        function prevTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialStep();
            }
        }

        // Tutorial event listeners
        document.getElementById('tutorial-btn').addEventListener('click', showTutorial);
        document.getElementById('tutorial-skip').addEventListener('click', closeTutorial);
        document.getElementById('tutorial-next').addEventListener('click', nextTutorialStep);
        document.getElementById('tutorial-prev').addEventListener('click', prevTutorialStep);

        // Show tutorial on first visit (session-based)
        let hasSeenTutorial = false;
        window.addEventListener('load', () => {
            if (!hasSeenTutorial) {
                setTimeout(() => {
                    showTutorial();
                    hasSeenTutorial = true;
                }, 500);
            }
        });

        // Update highlight position on window resize
        window.addEventListener('resize', () => {
            if (tutorialActive) {
                const step = tutorialSteps[currentTutorialStep];
                updateTutorialHighlight(step.highlight);
            }
        });

        // ========== STAGE SYSTEM FUNCTIONS ==========

        // Show stage selection modal
        function showStageSelection() {
            renderStageList();
            document.getElementById('stage-modal').classList.remove('hidden');
        }

        // Close stage selection modal
        function closeStageModal() {
            document.getElementById('stage-modal').classList.add('hidden');
        }

        // Render stage list
        function renderStageList() {
            const stageList = document.getElementById('stage-list');
            stageList.innerHTML = '';

            stages.forEach(stage => {
                const isUnlocked = stage.id <= gameState.stageProgress.unlockedStages;
                const stars = gameState.stageProgress.stageStars[stage.id] || 0;

                const difficultyColors = {
                    'ç°¡å–®': 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300',
                    'ä¸­ç­‰': 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300',
                    'å›°é›£': 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300',
                    'å°ˆå®¶': 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'
                };

                const stageCard = document.createElement('div');
                stageCard.className = `relative bg-white dark:bg-gray-700 rounded-lg p-4 shadow transition-all ${
                    isUnlocked ? 'cursor-pointer hover:shadow-xl hover:scale-105' : 'opacity-50'
                }`;

                if (isUnlocked) {
                    stageCard.onclick = () => startStage(stage.id);
                }

                let starsDisplay = '';
                for (let i = 0; i < 3; i++) {
                    starsDisplay += i < stars ? 'â­' : 'â˜†';
                }

                const minutes = Math.floor(stage.objectives.timeLimit / 60);
                const seconds = stage.objectives.timeLimit % 60;
                const timeText = seconds > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${minutes}:00`;

                stageCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="text-3xl">${stage.icon}</div>
                            <div>
                                <div class="font-bold text-lg">é—œå¡ ${stage.id}</div>
                                <div class="text-xs ${difficultyColors[stage.difficulty]} px-2 py-0.5 rounded-full inline-block mt-1">
                                    ${stage.difficulty}
                                </div>
                            </div>
                        </div>
                        ${!isUnlocked ? '<div class="text-2xl">ğŸ”’</div>' : ''}
                    </div>

                    <h4 class="font-bold text-gray-900 dark:text-white mb-1">${stage.name}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">${stage.description}</p>

                    ${stars > 0 ? `
                        <div class="text-center mb-3 text-xl">
                            ${starsDisplay}
                        </div>
                    ` : ''}

                    <div class="space-y-1 text-xs text-gray-600 dark:text-gray-400">
                        <div class="flex justify-between">
                            <span>ğŸ“¦ ç›®æ¨™é…é€ï¼š</span>
                            <span class="font-bold">${stage.objectives.deliveries} å–®</span>
                        </div>
                        <div class="flex justify-between">
                            <span>â±ï¸ æ™‚é–“é™åˆ¶ï¼š</span>
                            <span class="font-bold">${timeText}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>â­ æœ€ä½è©•åˆ†ï¼š</span>
                            <span class="font-bold">${stage.objectives.minRating.toFixed(1)}</span>
                        </div>
                    </div>

                    ${isUnlocked ? `
                        <button class="w-full mt-3 bg-primary hover:bg-primary/90 text-white font-bold py-2 px-3 rounded text-sm transition">
                            é–‹å§‹æŒ‘æˆ°
                        </button>
                    ` : `
                        <div class="w-full mt-3 bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 font-bold py-2 px-3 rounded text-sm text-center">
                            æœªè§£é–
                        </div>
                    `}
                `;

                stageList.appendChild(stageCard);
            });
        }

        // Start a specific stage
        function startStage(stageId) {
            const stage = stages.find(s => s.id === stageId);
            if (!stage) return;

            if (stageId > gameState.stageProgress.unlockedStages) {
                showNotification('âš ï¸ è«‹å…ˆå®Œæˆå‰é¢çš„é—œå¡ï¼', 'warning');
                return;
            }

            // Reset game state
            resetGame();

            // Set stage mode
            gameState.stageMode = true;
            gameState.currentStage = stage;

            // Close modal
            closeStageModal();

            // Start game with stage configuration
            startGameWithStageConfig(stage);

            showNotification(`ğŸ¯ ${stage.name} é–‹å§‹ï¼`, 'info');
        }

        // Start game with stage configuration
        function startGameWithStageConfig(stage) {
            if (gameState.isRunning) return;

            gameState.isRunning = true;
            document.getElementById('start-btn').textContent = 'â¸ï¸ éŠæˆ²é€²è¡Œä¸­...';
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').classList.add('opacity-50', 'cursor-not-allowed');

            // Update header to show stage info
            document.getElementById('stage-info').classList.remove('hidden');
            document.getElementById('level-info').classList.add('hidden');
            document.getElementById('current-stage-name').textContent = `${stage.icon} ${stage.name}`;
            document.getElementById('game-mode-text').textContent = stage.description;
            updateStageProgressDisplay();

            // Game timer
            gameState.gameTimer = setInterval(() => {
                gameState.time++;
                updateTime();
                updateStageProgressDisplay();

                // Check time limit in stage mode
                if (gameState.stageMode && gameState.time >= stage.objectives.timeLimit) {
                    checkStageCompletion();
                }

                // Update order timers
                gameState.orders.forEach(order => {
                    order.timeRemaining--;
                    if (order.timeRemaining <= 0) {
                        gameState.orders = gameState.orders.filter(o => o.id !== order.id);
                        showNotification('ğŸ“¦ è¨‚å–®å·²å–æ¶ˆï¼ˆè¶…æ™‚ï¼‰', 'warning');
                    }
                });

                // Update current delivery timer
                if (gameState.currentDelivery) {
                    gameState.currentDelivery.timeRemaining--;
                    updateCurrentDelivery();
                }

                renderOrders();
            }, 1000);

            // Start order generation with stage config
            gameState.orderTimer = setInterval(() => {
                if (gameState.orders.length < stage.maxOrders) {
                    generateOrderWithMultiplier(stage.rewardMultiplier);
                }
            }, stage.orderInterval);

            // Generate initial orders
            generateOrderWithMultiplier(stage.rewardMultiplier);
            setTimeout(() => generateOrderWithMultiplier(stage.rewardMultiplier), 3000);
        }

        // Update stage progress display in header
        function updateStageProgressDisplay() {
            if (!gameState.stageMode || !gameState.currentStage) return;

            const stage = gameState.currentStage;
            document.getElementById('stage-progress-text').textContent =
                `${gameState.completed}/${stage.objectives.deliveries}`;

            const timeLeft = Math.max(0, stage.objectives.timeLimit - gameState.time);
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('stage-time-left').textContent =
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Generate order with custom reward multiplier
        function generateOrderWithMultiplier(multiplier) {
            const availableBuildings = gameState.buildings.filter((b, i) =>
                !gameState.orders.some(o => o.destination === i) &&
                (!gameState.currentDelivery || gameState.currentDelivery.destination !== i)
            );

            if (availableBuildings.length === 0) return;

            const randomBuilding = availableBuildings[Math.floor(Math.random() * availableBuildings.length)];
            const buildingIndex = gameState.buildings.findIndex(b => b === randomBuilding);

            const items = ['ğŸ“¦ åŒ…è£¹', 'ğŸ• å¤–è³£', 'ğŸ“„ æ–‡ä»¶', 'ğŸ ç¦®ç‰©', 'ğŸ›ï¸ è³¼ç‰©', 'ğŸ’ é®®èŠ±'];
            const item = items[Math.floor(Math.random() * items.length)];

            const baseReward = Math.floor(Math.random() * 30) + 20;
            const reward = Math.floor(baseReward * multiplier);

            const baseTime = Math.floor(Math.random() * 30) + 30;
            const timeLimit = Math.max(20, baseTime);

            const order = {
                id: Date.now() + Math.random(),
                item,
                destination: buildingIndex,
                destinationName: randomBuilding.name,
                reward,
                timeLimit,
                timeRemaining: timeLimit
            };

            gameState.orders.push(order);
            renderOrders();
        }

        // Check stage completion
        function checkStageCompletion() {
            if (!gameState.stageMode || !gameState.currentStage) return;

            const stage = gameState.currentStage;
            const objectives = stage.objectives;

            // Stop game
            if (gameState.gameTimer) clearInterval(gameState.gameTimer);
            if (gameState.orderTimer) clearInterval(gameState.orderTimer);
            gameState.isRunning = false;

            // Check if objectives are met
            const deliveriesMet = gameState.completed >= objectives.deliveries;
            const timeMet = gameState.time <= objectives.timeLimit;
            const ratingMet = gameState.rating >= objectives.minRating;

            if (deliveriesMet && timeMet && ratingMet) {
                // Calculate stars
                let stars = 1; // Bronze
                if (gameState.completed >= stage.stars.gold.deliveries &&
                    gameState.time <= stage.stars.gold.time &&
                    gameState.rating >= stage.stars.gold.rating) {
                    stars = 3; // Gold
                } else if (gameState.completed >= stage.stars.silver.deliveries &&
                           gameState.time <= stage.stars.silver.time &&
                           gameState.rating >= stage.stars.silver.rating) {
                    stars = 2; // Silver
                }

                // Update progress
                const previousStars = gameState.stageProgress.stageStars[stage.id] || 0;
                if (stars > previousStars) {
                    gameState.stageProgress.stageStars[stage.id] = stars;
                }

                // Unlock next stage
                if (stage.id === gameState.stageProgress.unlockedStages && stage.id < stages.length) {
                    gameState.stageProgress.unlockedStages = stage.id + 1;
                }

                showStageComplete(stars);
            } else {
                showStageFailed(deliveriesMet, timeMet, ratingMet);
            }
        }

        // Show stage complete modal
        function showStageComplete(stars) {
            const stage = gameState.currentStage;

            let starsDisplay = '';
            for (let i = 0; i < stars; i++) {
                starsDisplay += 'â­';
            }

            document.getElementById('stage-stars-display').textContent = starsDisplay;
            document.getElementById('stage-complete-name').textContent = stage.name;

            const minutes = Math.floor(gameState.time / 60);
            const seconds = gameState.time % 60;
            document.getElementById('stage-time-result').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('stage-deliveries-result').textContent = gameState.completed;
            document.getElementById('stage-rating-result').textContent = gameState.rating.toFixed(1);
            document.getElementById('stage-money-result').textContent = `HK$${gameState.money}`;

            // Show/hide next stage button
            const nextStageBtn = document.getElementById('next-stage-btn');
            if (stage.id < stages.length) {
                nextStageBtn.classList.remove('hidden');
            } else {
                nextStageBtn.classList.add('hidden');
            }

            document.getElementById('stage-complete-modal').classList.remove('hidden');
        }

        // Show stage failed modal
        function showStageFailed(deliveriesMet, timeMet, ratingMet) {
            const stage = gameState.currentStage;

            let reasons = [];
            if (!deliveriesMet) reasons.push(`ğŸ“¦ é…é€ä¸è¶³ï¼ˆ${gameState.completed}/${stage.objectives.deliveries}ï¼‰`);
            if (!timeMet) reasons.push('â±ï¸ è¶…æ™‚');
            if (!ratingMet) reasons.push(`â­ è©•åˆ†éä½ï¼ˆ${gameState.rating.toFixed(1)}/${stage.objectives.minRating.toFixed(1)}ï¼‰`);

            document.getElementById('stage-failed-reason').innerHTML = reasons.join('<br>');

            const minutes = Math.floor(gameState.time / 60);
            const seconds = gameState.time % 60;
            document.getElementById('stage-failed-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('stage-failed-deliveries').textContent = `${gameState.completed}/${stage.objectives.deliveries}`;
            document.getElementById('stage-failed-rating').textContent = gameState.rating.toFixed(1);

            document.getElementById('stage-failed-modal').classList.remove('hidden');
        }

        // Close stage complete modal
        function closeStageCompleteModal() {
            document.getElementById('stage-complete-modal').classList.add('hidden');
            showStageSelection();
        }

        // Close stage failed modal
        function closeStageFailedModal() {
            document.getElementById('stage-failed-modal').classList.add('hidden');
            showStageSelection();
        }

        // Start next stage
        function startNextStage() {
            closeStageCompleteModal();
            const nextStageId = gameState.currentStage.id + 1;
            if (nextStageId <= stages.length) {
                startStage(nextStageId);
            }
        }

        // Retry current stage
        function retryStage() {
            closeStageFailedModal();
            if (gameState.currentStage) {
                startStage(gameState.currentStage.id);
            }
        }

        // Modified complete delivery to check stage completion
        const originalCompleteDelivery = completeDelivery;
        completeDelivery = function() {
            originalCompleteDelivery();

            // Check if stage objectives are met after each delivery
            if (gameState.stageMode && gameState.currentStage) {
                const stage = gameState.currentStage;
                if (gameState.completed >= stage.objectives.deliveries) {
                    setTimeout(() => {
                        checkStageCompletion();
                    }, 1000);
                }
            }
        };

        // Event listeners
        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('reset-btn').addEventListener('click', resetGame);
        document.getElementById('stage-select-btn').addEventListener('click', showStageSelection);

        // Load saved stage progress from localStorage
        function loadStageProgress() {
            try {
                const saved = localStorage.getItem('deliveryGameStageProgress');
                if (saved) {
                    const data = JSON.parse(saved);
                    gameState.stageProgress.unlockedStages = data.unlockedStages || 1;
                    gameState.stageProgress.stageStars = data.stageStars || {};
                }
            } catch (e) {
                console.error('Failed to load stage progress:', e);
            }
        }

        // Save stage progress to localStorage
        function saveStageProgress() {
            try {
                localStorage.setItem('deliveryGameStageProgress', JSON.stringify({
                    unlockedStages: gameState.stageProgress.unlockedStages,
                    stageStars: gameState.stageProgress.stageStars
                }));
            } catch (e) {
                console.error('Failed to save stage progress:', e);
            }
        }

        // Modified showStageComplete to save progress
        const originalShowStageComplete = showStageComplete;
        showStageComplete = function(stars) {
            originalShowStageComplete(stars);
            saveStageProgress();
        };

        // Initialize
        loadStageProgress();
        initBuildings();
        updateStats();
        updateTime();
        updateLevelDisplay();
    </script>
</body>
</html>


